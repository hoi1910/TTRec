TVTest TTRec Plugin ver.0.3

■概要
TVTestのEPG番組情報を使ってキーワード検索予約録画を行うプラグインです。
以下の機能があります。
・TVTest付属のEPG番組表から予約登録・変更
・タスクスケジューラを利用して予約時刻に自動復帰・TVTest起動
・TOT時刻補正で内部時計のずれに対応
・TVTest複数起動に対応

■動作環境
・Windows XP以降(ただしVistaは未確認)
・TVTest ver.0.7.16(32bit)以降、or対応するTVH264

■使い方
・TVTestのPluginsフォルダにTTRec.tvtpを入れ、TVTestを起動してください。プラグイ
  ン設定は 右クリックメニュー→設定→プラグイン→TTRec から行います。最低限、こ
  のプラグイン設定画面で"使用するBonDriver"を指定し、TVTestを再起動するか右クリ
  ックメニューからTTRecを有効化すれば、プラグインは利用可能になります
・予約を行うときは、EPG番組表→右クリックメニュー から予約設定・キーワード検索予
  約登録(クエリ設定)を選択してください
・録画停止の確認をとることを勧めます(設定→録画→録画停止は確認をとる)

■以前のバージョン(ver.0.1,ver.0.2)からの移行
・TTRec.tvtpを置き換えてください。設定や予約はそのまま引き継げます
・TVTestの複数起動を禁止する必要はなくなりました
・ver.0.2以降では、プラグイン設定の"使用するBonDriver"が指定されていればプラグイ
  ンは起動時に有効化します。起動時に無効化したいときは、この項目を空欄にしてくだ
  さい

■プラグイン設定
[使用するBonDriver]
  指定したBonDriverがTVTest起動時に使われていればプラグインを有効化します。また、
  タスクスケジューラからの起動やチャンネル変更時に、このドライバを使います。
[TOT時刻補正]
  指定の範囲内で放送波の時刻情報(Time Offset Table)を利用して時刻補正します。録
  画開始が大体ピッタリになります。PCの内部時計は変更しません。
[タスクスケジューラを使う]
  タスクスケジューラを利用してスリープからの復帰とTVTest起動を行います。復帰マー
  ジンを0にするとタスク登録を削除できます。
[連続する予約イベントを1ファイルにまとめる]
  チャンネル変更のいらない連続した番組は、そのまま録画を継続することで1つのファ
  イルにまとめます。
[録画前ﾁｬﾝﾈﾙ変更・録画前スピンアップ]
  録画前にチャンネル変更や録画先HDDのスピンアップを行います。最小値は15秒で、そ
  れぞれ0にすると行いません(チャンネル変更はEPG情報更新のために推奨)。
[デフォルト録画設定]
  予約登録でそれぞれデフォルトにしたときに適用される値を指定。開始・終了マージン
  はそれぞれ600秒まで指定可能です。終了マージンはマイナスの値も指定可能です。

■予約設定(予約登録・予約変更)
[イベント名]
  保存ファイル名の %event-name% がこの値に置き換わります。

■クエリ設定(クエリ登録)
[キーワード]
  検索キーワードを空白で区切って複数指定できます。番組タイトルにキーワードがすべ
  て含まれるとマッチ(正規表現機能なし)。
[検索期間]
  この期間内に開始する番組を探します。例えば、"火"にチェックを入れ21時0分から6時
  間0分を指定すれば、火曜の21時0分から水曜の2時59分までに始まる番組を探します。
[ジャンル]
  指定したジャンルの番組を探します。
[イベント名を指定]
  指定しなければ番組タイトルを使用します。指定するとそのイベント名で予約を生成し
  ます。%num%に1以上を使用すると、予約生成のたびに値を増分し、イベント名に含まれ
  る%num%、%num2%がこの値に置き換わります(話数付加に便利)。
[無効にする]
  クエリを無効にすると新しい予約が生成されなくなります。
[見るだけ]
  チェックをいれると録画動作のみを省略します。視聴忘れの防止に利用できます。

■優先度について
優先度は1から5までで、予約が重複した場合に数字の大きい予約を優先して録画します。
例えば、優先度3の予約を録画中に優先度4の予約が始まる場合、前者の録画は終了し、後
者の録画が始まります。また、いかなる優先度の予約でも、ユーザによる録画(ステータ
スバーの録画ボタンなどを使った録画)を中断することはありません。
"見るだけ"予約の優先度は、通常予約のあらゆる優先度よりも低くなります。

■仕様(という名の不具合)
・まだあまり枯れてません。特に番組延長や移動はテスト回数がまだ少ないのでどの程度
  対応できるか分かりません
・クエリ登録件数は100件までです。予約件数は無制限ですが、一覧は直近100件までしか
  表示されません
・イベントリレーには対応していません(この辺ARIB仕様もあんま読んでない…)
・当方KTV-FSUSB2使いです。地上波以外(BS・CS)も正しく録画できるか不明です
・当方チューナ1つしかありません。TVTest複数で正しく運用できるか不明です
・本体プログラムのファイル名は"TVTest.exe" or "TVH264.exe"である必要があります。
  これ以外のファイル名だとタスクスケジューラからの起動に失敗します

■上級者向け
[設定ファイル(TTRec.ini)の隠しキー]
  SuspendMargin= 次の予約開始まで (SuspendMargin+ResumeMargin)分なければ録画終了
                 後のスリープ動作を行いません
  SuspendWait= TVTestを終了後、何秒後にPCをスリープにするか
  ExecWait= PCがスリープから復帰後、何秒後にTVTestを起動するか
  ForceSuspend= 強制的にスリープする(=1)かどうか(SetSuspendStateの2番目の引数)
  *Color= EPG番組表のイベントを囲う枠の色
[複数チューナで使いたい]
  TTRec.tvtpを適当にリネーム(たとえば、"TTRec1.tvtp"と"TTRec2.tvtp"など)して
  Pluginsフォルダに置き、プラグイン設定の"使用するBonDriver"を各々選択してくださ
  い。プラグインが有効なTVTestが他に起動していれば、録画終了後にスリープは行いま
  せん(スリープ確認のダイアログは出ます)。
  注意点ですが、プラグイン同士での予約の融通(空いてるチューナを判断して割り振る
  など)といったレベルの高いことはできません。

■ソースについて
当プラグインはEDCBSupportプラグインをベースにしつつTVTest本体からいくらかコード
を流用しています(感謝!)。流用元はソースコメントに記述してあります。その他の部分
は勝手に改変・利用してもらって構いません。

■更新履歴
ver.0.3 (2011-07-05)
・スレッドの書き込みをもとに2点追加してみた
  ・終了マージンに負の値を設定できるようにした
  ・録画無しで予約するオプションを追加した #たしかにこれ便利かも
ver.0.2 (2011-07-03)
・プラグインが有効なTVTestが他に起動していればスリープしないようにした
・タスクスケジューラからの起動時、すでに同名のプラグインが起動していないか確認す
  るようにした(=複数起動禁止が不要に)
・録画関連の変更は無し
ver.0.1 (2011-06-30)
・初版
