TVTest TTRec Plugin ver.0.6

■概要
TVTestのEPG番組情報を使ってキーワード検索予約録画を行うプラグインです。
以下の機能があります。
・TVTest付属のEPG番組表から予約登録・変更
・タスクスケジューラを利用して予約時刻に自動復帰・TVTest起動
・TOT時刻補正で内部時計のずれに対応
・TVTest複数起動に対応

■動作環境
・Windows XP以降(ただしVistaは未確認)
・TVTest ver.0.7.16以降、or対応するTVH264

■使い方
・TVTestのPluginsフォルダにTTRec.tvtp (x64版のTVTestはTTRec(x64).tvtp)を入れ、
  TVTestを起動してください。プラグイン設定は 右クリックメニュー→設定→プラグイ
  ン→TTRec から行います。最低限、このプラグイン設定画面で"使用するBonDriver"を
  指定し、TVTestを再起動するか右クリックメニューからTTRecを有効化すれば、プラグ
  インは利用可能になります
・予約を行うときは、EPG番組表→右クリックメニュー から予約設定・キーワード検索予
  約登録(クエリ設定)を選択してください
・録画停止の確認をとることを勧めます(設定→録画→録画停止は確認をとる)

■以前のバージョン(ver.0.1～ver.0.5)からの移行
・TTRec.tvtpを置き換えてください。設定や予約はそのまま引き継げます
・TVTestの複数起動を禁止する必要はなくなりました
・ver.0.2以降では、プラグイン設定の"使用するBonDriver"が指定されていればプラグイ
  ンは起動時に有効化します。起動時に無効化したいときは、この項目を空欄にしてくだ
  さい
・ver.0.5には今のところ大きなバグは見つかっていないので、ver.0.6への移行はしばら
  く様子見でも構いません

■プラグイン設定
[使用するBonDriver]
  指定したBonDriverがTVTest起動時に使われていればプラグインを有効化します。また、
  タスクスケジューラからの起動やチャンネル変更時に、このドライバを使います。
[TOT時刻補正]
  指定の範囲内で放送波の時刻情報(Time Offset Table)を利用して時刻補正します。録
  画開始が大体ピッタリになります。PCの内部時計は変更しません。
[タスクスケジューラを使う]
  タスクスケジューラを利用してスリープからの復帰とTVTest起動を行います。復帰マー
  ジンを0にするとタスク登録を削除できます。
[連続する予約イベントを1ファイルにまとめる]
  チャンネル変更のいらない連続した番組は、そのまま録画を継続することで1つのファ
  イルにまとめます。
[見るだけ予約が始まるとき、再生オンにする]
  "見るだけ"予約のときTVTestが最小化されていれば最小化を解除し、再生オフならオン
  にします。
[録画前ﾁｬﾝﾈﾙ変更・録画前スピンアップ]
  録画前にチャンネル変更や録画先HDDのスピンアップを行います。最小値は15秒で、そ
  れぞれ0にすると行いません(チャンネル変更はEPG情報更新のために推奨)。なお、
  TTRecは録画開始前に再度チャンネル設定を行うので、チャンネル変更後にユーザがチ
  ャンネルを操作しても大丈夫です(裏番組をギリギリまで見れます)。
[バルーンで通知]
  デスクトップのタスクトレイ領域にバルーンチップを表示します。「警告」はTTRecに
  エラーが発生したとき、「録画イベント」は録画開始や終了時に通知します。
[デフォルト録画設定]
  予約登録でそれぞれデフォルトにしたときに適用される値を指定。開始・終了マージン
  はそれぞれ600秒まで、終了マージンはマイナスの値も指定可能です。変更は登録済み
  の予約にも適用されます("見るだけ"チェックボックスを除く)。

■予約設定(予約登録・予約変更)
※予約イベントの時刻はTVTest起動中に随時チェックします。直近の5番組は30秒ごと、
それ以降の番組は30秒ごとに1つずつ、TVTestのEPG情報と照合します。番組の消滅(たま
にあります)には対応していません(予約が残ったままになります)。
[イベント名]
  保存ファイル名の %event-name% がこの値に置き換わります。

■クエリ設定(クエリ登録)
※クエリからの予約作成はTVTestのEPG情報をもとに随時おこないます。基本的に60秒で
クエリチェックは一巡します(クエリ数が多い場合は2秒×{クエリ数}で一巡)。
[キーワード]
  検索キーワードを空白で区切って複数指定できます。番組タイトルにキーワードがすべ
  て含まれるとマッチ(正規表現機能なし)。キーワードの先頭が半角ハイフン'-'の場合
  は除外検索になります。
  例:
    (番組タイトル1) = "月曜討論「どうなる退陣３条件」"
    (番組タイトル2) = "[再]月曜討論「どうなる退陣３条件」"
    "月曜討論 どうなる"      : (番組タイトル1),(番組タイトル2)にマッチ
    "月曜討論 -[再] どうなる": (番組タイトル1)にマッチ
    "月曜討論 [再] どうなる" : (番組タイトル2)にマッチ
[検索期間]
  この期間内に開始する番組を探します。例えば、"火"にチェックを入れ21時0分から6時
  間0分を指定すれば、火曜の21時0分から水曜の2時59分までに始まる番組を探します。
[ジャンル]
  指定したジャンルの番組を探します。
[イベント名を指定]
  指定しなければ番組タイトルを使用します。指定するとそのイベント名で予約を生成し
  ます。%num%に1以上を使用すると、予約生成のたびに値を増分し、イベント名に含まれ
  る%num%、%num2%がこの値に置き換わります(話数付加に便利)。
[無効にする]
  クエリを無効にすると新しい予約が生成されなくなります。
[見るだけ]
  チェックをいれると録画動作のみを省略します。視聴忘れの防止に利用できます。

■優先度について
優先度は1から5までで、予約が重複した場合に数字の大きい予約を優先して録画します。
例えば、優先度3の予約を録画中に優先度4の予約が始まる場合、前者の録画は終了し、後
者の録画が始まります。また、いかなる優先度の予約でも、ユーザによる録画(ステータ
スバーの録画ボタンなどを使った録画)を中断することはありません。
"見るだけ"予約の優先度は、通常予約のあらゆる優先度よりも低くなります。

■TVTest起動オプションについて
プラグイン設定の"TVTest起動オプション"を指定すると、タスクスケジューラのTVTest起
動コマンドにこのオプションが追加されます。ドライバ指定オプション(/d foo.dll)はあ
らかじめ付加されているため指定する必要はありません。
例:
  "/mute"          消音にする
  "/min /nodshow"  最小化 + 起動時にDirectShowを初期化しない
  "/standby"       待機状態で起動する(うまくいかないかも…下記参照)
この辺はTVTestの説明ファイルを読んでいろいろ組み合わせてみてください。

■その他
[EPG番組表の装飾の意味]
  予約登録すると、その番組は緑色の線で囲われます。"見るだけ"予約の場合は破線にな
  ります。また、つぎに録画される番組はオレンジで囲われ、さらに現在録画中であれば
  赤色になります。予約が被っていたりして録画時間が短くなる予定のときは、オレンジ
  で囲われる部分が小さくなるので、大体の目安にもなります。
[録画とスリープについて]
  ここでは、スタンバイと休止状態をまとめてスリープと表現します。また、録画開始の
  数分前 (具体的には(SuspendMargin+ResumeMargin)分前) から録画終了までを、"録画
  とその準備中"と表現します。
  Vista以降のWindowsは、スリープから復帰後ユーザ操作がなければ、デフォルトで2分
  後に再度スリープします。TTRecは"録画とその準備中"にこれを阻止します。したがっ
  て、Vista以降は録画終了後動作を「何もしない」または「TVTestを終了」でも、自動
  復帰→スリープの運用ができます。
  さらに、TTRec ver.0.5以降は"録画とその準備中"にユーザによるスリープ(スタートメ
  ニューからスリープボタンを押すなど)も阻止します。このとき、Vista以降はAwayMode
  (詳細は検索してください)になります。

■仕様(という名の不具合)
・モニタの電源が切れている状態では、DirectShow絡みのエラーでTVTestが正常に起動し
  ない環境があるようです。恐らくレンダラによるエラーなので、レンダラをかえるか、
  起動オプションに/nodshowを指定して回避してください
・クエリ登録件数は100件までです。予約件数は無制限ですが、一覧は直近100件までしか
  表示されません
・番組延長や移動に対応していますが、番組消滅やイベントリレーには対応していません
・当方KTV-FSUSB2使いです。地上波以外(BS・CS)も正しく録画できるか不明です
・当方チューナ1つしかありません。TVTest複数で正しく運用できるか不明です
・本体プログラムのファイル名は"TVTest.exe" or "TVH264.exe"である必要があります。
  これ以外のファイル名だとタスクスケジューラからの起動に失敗します
・当方環境ではTVTest待機状態から録画できませんでした(プラグイン無しでも同様なの
  で、こちらの環境が悪いか、KTVとの相性だと思います)

■上級者向け
[設定ファイル(TTRec.ini)の隠しキー]
  SuspendMargin= 次の予約開始まで (SuspendMargin+ResumeMargin)分なければ録画終了
                 後のスリープ動作を行いません
  SuspendWait= TVTestを終了後、何秒後にPCをスリープにするか
  ExecWait= PCがスリープから復帰後、何秒後にTVTestを起動するか
  ForceSuspend= 強制的にスリープする(=1)かどうか(SetSuspendStateの2番目の引数)
  *Color= EPG番組表のイベントを囲う枠の色
[複数チューナで使いたい]
  TTRec.tvtpを適当にリネーム(たとえば、"TTRec1.tvtp"と"TTRec2.tvtp"など)して
  Pluginsフォルダに置き、プラグイン設定の"使用するBonDriver"を各々選択してくださ
  い。プラグインが有効なTVTestが他に起動していれば、録画終了後にスリープは行いま
  せん(スリープ確認のダイアログは出ます)。
  注意点ですが、プラグイン同士での予約の融通(空いてるチューナを判断して割り振る
  など)といったレベルの高いことはできません。

■ソースについて
当プラグインはEDCBSupportプラグインをベースにしつつTVTest本体からいくらかコード
を流用しています(感謝!)。流用元はソースコメントに記述してあります。その他の部分
は勝手に改変・利用してもらって構いません。

■更新履歴
ver.0.6 (2012-01-06)
・"見るだけ"予約をデフォルト設定できるようにした
・バルーン通知機能をつけた
・予約ファイルアクセスのエラー耐性強化
・タスクスケジューラ登録のエラーチェック厳密化
・録画中に終了後動作を変更しても適用されなかったのを修正
・コードを少し整理
ver.0.5 (2011-09-25)
・改編期にあわせて微調整
  ・タスクスケジューラへの登録処理の待ち時間が結構長いので、別スレッドにした
    ・予約登録のレスポンスが向上
  ・録画中はユーザ操作によるスリープ移行を阻止するようにした
  ・"TTRec.tvtp"以外にリネームした場合、タイトルバーにファイル名を表示して、区別
    できるようにした
  ・x64版も付けてみた
  ・その他微修正
ver.0.4 (2011-07-24)
・除外検索を追加した
・動作に関する細かい修正
  ・予約が連続している場合に後続の録画開始前のHDDスピンアップが行われない場合が
    あったのを修正
  ・"見るだけ"予約開始時に再生オフであればオンになるようにした
  ・TOTセクションの取得部分をより厳密にした
ver.0.3 (2011-07-05)
・スレッドの書き込みをもとに2点追加してみた
  ・終了マージンに負の値を設定できるようにした
  ・録画無しで予約するオプションを追加した #たしかにこれ便利かも
ver.0.2 (2011-07-03)
・プラグインが有効なTVTestが他に起動していればスリープしないようにした
・タスクスケジューラからの起動時、すでに同名のプラグインが起動していないか確認す
  るようにした(=複数起動禁止が不要に)
・録画関連の変更は無し
ver.0.1 (2011-06-30)
・初版
